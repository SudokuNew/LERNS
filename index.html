<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <title>LERNS — Test Planner</title>

    <!-- Mobile / PWA meta -->
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="theme-color" content="#0BDAFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/lerns-180.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icons/favicon-32.png" sizes="32x32">
    <link rel="stylesheet" href="css/style.css">

    <!-- Basic styles (can move to /css/style.css) -->
</head>

<body>
    <div class="bg-fixed" aria-hidden="true"></div>
    <!-- Intro Video Overlay (plays once by default) -->
    <div class="app">
        <div id="intro-overlay" class="intro-overlay" aria-hidden="false">
            <video id="intro-video" class="intro-video" playsinline muted preload="auto"
                poster="/media/intro-poster.jpg" crossorigin="anonymous">
                <source src="/media/intro.mp4" type="video/mp4">
            </video>
            <div class="intro-controls">
                <button id="skip-btn" class="btn ghost" aria-label="スキップ">Skip</button>
                <button id="unmute-btn" class="btn unmute" aria-hidden="true">Enable Sound</button>
            </div>
        </div>

        <!-- App main -->
        <div class="app" id="app" role="application" aria-label="LERNS learning app">
            <header class="top-hero fade-in-on-load-1">
                <div class="hero-bg">
                    <img class="hero-icon" src="/icons/lerns-192.png" alt="" aria-hidden="true">
                    <div class="hero-content">
                        <h1>L.E.R.N.S.</h1>
                        <p class="subtitle">勉強時間を記録して、計画を着実に進めよう</p>
                    </div>
                </div>
            </header>

            <main>
                <section class="quick-actions" aria-label="主な操作">
                    <button id="btn-log-time" class="action-btn fade-in-on-load-2"
                        aria-controls="log-time-modal">勉強時間を記録</button>
                    <button id="btn-view-schedule" class="action-btn toggle-button fade-in-on-load-2"
                        aria-controls="pdfViewer" aria-expanded="false">計画表を見る</button>


                </section>

                <section style="padding:0 16px">
                    <div id="stats">
                        <div id="total-time">合計学習時間: 0 分</div>
                    </div>
                    <div id="pdfViewer" class="pdf-wrapper" role="region" aria-label="計画表" style="display:none;">
                        <iframe src="docs/plan_grade2_2nd.pdf" width="100%" height="600px" style="border:none;"
                            tabindex="-1"></iframe>
                        <div style="margin-top:0.5rem;">
                            <a href="docs/plan_grade2_2nd.pdf" target="_blank" rel="noopener">PDFを新しいタブで開く</a>
                            &nbsp;|&nbsp;
                            <a href="docs/plan_grade2_2nd.pdf" download>PDFをダウンロード</a>
                        </div>
                    </div>

                </section>
            </main>

            <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:auto;padding:12px">Local mode
                ·
                For personal use</footer>
        </div>

        <!-- Modals -->
        <div id="log-time-modal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="log-time-title">
            <div class="modal-panel">
                <h2 id="log-time-title">勉強時間を記録</h2>
                <label style="display:block;margin-top:8px">科目
                    <select id="subject-select" style="width:100%;padding:8px;margin-top:6px">
                        <option>数学</option>
                        <option>英語</option>
                        <option>国語</option>
                        <option>理科</option>
                    </select>
                </label>
                <label style="display:block;margin-top:8px">時間（分）
                    <input id="study-minutes" type="number" min="1" value="30"
                        style="width:100%;padding:8px;margin-top:6px">
                </label>
                <div class="modal-actions">
                    <button id="save-time" class="btn primary">保存</button>
                    <button class="btn" data-action="close-modal">キャンセル</button>
                </div>
            </div>
        </div>

        <div id="schedule-modal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="schedule-title">
            <div class="modal-panel">
                <h2 id="schedule-title">計画表</h2>
                <div id="schedule-content" style="margin-top:10px;max-height:50vh;overflow:auto"></div>
                <div class="modal-actions">
                    <button class="btn" data-action="close-modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        /* Service worker registration (PWA) */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').catch(() => {/* ignore */ });
        }

        /* App logic: logs, UI, modals */
        (function () {
            const LOG_KEY = 'lerns_logs';
            function readLogs() { try { return JSON.parse(localStorage.getItem(LOG_KEY) || '[]'); } catch (e) { return []; } }
            function writeLogs(logs) { localStorage.setItem(LOG_KEY, JSON.stringify(logs)); renderStats(); }
            function renderStats() {
                const logs = readLogs();
                const total = logs.reduce((s, l) => s + (l.minutes || 0), 0);
                const el = document.getElementById('total-time');
                if (el) el.textContent = `合計学習時間: ${total} 分`;
            }

            function openModal(modal) { modal.setAttribute('aria-hidden', 'false'); modal.querySelector('input,select,button')?.focus(); document.body.style.overflow = 'hidden'; }
            function closeModal(modal) { modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; }

            document.addEventListener('DOMContentLoaded', function () {
                renderStats();

                const btnLog = document.getElementById('btn-log-time');
                const btnSchedule = document.getElementById('btn-view-schedule');
                const logModal = document.getElementById('log-time-modal');
                const scheduleModal = document.getElementById('schedule-modal');

                btnLog.addEventListener('click', () => openModal(logModal));
                btnSchedule.addEventListener('click', () => {
                    const viewer = document.getElementById('pdfViewer');
                    const isHidden = window.getComputedStyle(viewer).display === 'none';
                    if (isHidden) {
                        viewer.style.display = 'block';
                        btnSchedule.textContent = '計画表を閉じる';
                        btnSchedule.setAttribute('aria-expanded', 'true');
                        viewer.querySelector('iframe')?.focus();
                    } else {
                        viewer.style.display = 'none';
                        btnSchedule.textContent = '計画表を見る';
                        btnSchedule.setAttribute('aria-expanded', 'false');
                        btnSchedule.focus();
                    }
                });


                document.querySelectorAll('[data-action="close-modal"]').forEach(b => {
                    b.addEventListener('click', e => closeModal(e.target.closest('.modal')));
                });

                document.getElementById('save-time').addEventListener('click', () => {
                    const subject = document.getElementById('subject-select').value;
                    const minutes = parseInt(document.getElementById('study-minutes').value, 10) || 0;
                    const logs = readLogs();
                    logs.push({ subject, minutes, at: new Date().toISOString() });
                    writeLogs(logs);
                    alert('保存しました');
                    closeModal(logModal);
                });

                document.addEventListener('DOMContentLoaded', function () {
                    // 既存処理...
                    const btnSchedule = document.getElementById('btn-view-schedule');

                    // PDF表示の開閉（トグル）
                    btnSchedule.addEventListener('click', () => {
                        const viewer = document.getElementById('pdfViewer');
                        const isHidden = window.getComputedStyle(viewer).display === 'none';
                        if (isHidden) {
                            viewer.style.display = 'block';
                            btnSchedule.textContent = '計画表を閉じる';
                            btnSchedule.setAttribute('aria-expanded', 'true');
                            viewer.querySelector('iframe')?.focus();
                        } else {
                            viewer.style.display = 'none';
                            btnSchedule.textContent = '計画表を見る';
                            btnSchedule.setAttribute('aria-expanded', 'false');
                            btnSchedule.focus();
                        }
                    });

                    // 既存の btnSchedule に対するモーダルを開く処理があれば削除または無効化してください
                    // 例: btnSchedule.addEventListener('click', () => { renderSchedule(); openModal(scheduleModal); });
                });

                function renderSchedule() {
                    const container = document.getElementById('schedule-content');
                    const logs = readLogs();
                    if (logs.length === 0) {
                        container.innerHTML = '<p>記録がありません</p>';
                        return;
                    }
                    const list = logs.map(l => {
                        const t = new Date(l.at);
                        return `<div style="padding:8px;border-bottom:1px solid #eee"><strong>${l.subject}</strong> — ${l.minutes} 分<div style="font-size:12px;color:#666">${t.toLocaleString()}</div></div>`;
                    }).join('');
                    container.innerHTML = list;
                }
            });
        })();

        /* Intro video overlay logic: try autoplay muted, allow skip/unmute, show only once */
        (function () {
            const INTRO_KEY = 'lerns_intro_shown';
            try { if (localStorage.getItem(INTRO_KEY)) { document.getElementById('intro-overlay')?.remove(); } } catch (e) { }
            const overlay = document.getElementById('intro-overlay');
            const video = document.getElementById('intro-video');
            const skipBtn = document.getElementById('skip-btn');
            const unmuteBtn = document.getElementById('unmute-btn');
            if (!overlay || !video) return;

            const closeOverlay = () => { try { video.pause(); } catch (e) { } overlay.style.display = 'none'; overlay.setAttribute('aria-hidden', 'true'); try { localStorage.setItem(INTRO_KEY, '1'); } catch (e) { } };
            skipBtn.addEventListener('click', closeOverlay);
            unmuteBtn.addEventListener('click', () => {
                try { video.muted = false; video.play().catch(() => { }); } catch (e) { } setTimeout(closeOverlay, 600);
            });
            video.addEventListener('ended', closeOverlay);

            const tryPlay = async () => {
                try {
                    await video.play();
                    setTimeout(() => { unmuteBtn.style.display = 'inline-block'; }, 500);
                } catch (e) {
                    unmuteBtn.style.display = 'inline-block';
                }
            };
            document.addEventListener('DOMContentLoaded', tryPlay);
        })();
    </script>
</body>

</html>